#!/bin/bash
# shellcheck disable=SC2016
# shellcheck disable=SC2206

# Licensed under GPLv3, see https://www.gnu.org/licenses/

if [[ ! "$(grep pikaur_fake_makepkg_package PKGBUILD)" ]]  && [[ ! "$(grep pikaur_fake_makepkg_prepare PKGBUILD)" ]] ; then
	for line in $(grep "^prepare_.\+()" PKGBUILD -o) ; do
		echo -e "$line {\n echo \"fake_$line\"\n }" >> PKGBUILD
	done
	for line in $(grep "^package_.\+()" PKGBUILD -o) ; do
		echo -e "$line {\n echo \"fake_$line\"\n }" >> PKGBUILD
	done

filter_arg="--force-version"
forced_version=
args=($*)
new_args=()

echo "Orig args: ${args[*]}"

for arg in "${args[@]}" ; do
	if grep -q -- "$filter_arg" <<< "$arg" ; then
		forced_version="$(echo "$arg" | cut -d= -f2-999)"
	else
		new_args+=("$arg")
	fi
done

echo "New args: ${new_args[*]}"
if test -n "$forced_version" ; then
	echo "Forced version: $forced_version"
fi

source ./PKGBUILD
echo '

prepare() {
	echo "======= Fake prepare() ======="
	echo "pikaur_fake_makepkg_prepare"
}

build() {
	echo "======= Fake build() ======="
	echo "pikaur_fake_makepkg_build"
}

check() {
	echo "======= Fake check() ======="
	echo "pikaur_fake_makepkg_check"
}

source=(
	"http://example.com"
)
b2sums=(
	"SKIP"
)
' >> ./PKGBUILD


if grep -q "git" <<< "$pkgname" ; then
	echo '

	pkgver() {
		echo '"${forced_version:-99999.1.2.3}"'
	}
	' >> ./PKGBUILD
fi


# shellcheck disable=SC2154
if [ "${#pkgname[@]}" -eq 1 ] ; then
		echo "
package() {
	echo '======= Fake package() ======='
	echo 'pikaur_fake_makepkg_package'
}
	" >> ./PKGBUILD
else
	# shellcheck disable=SC2154
	for _pkg_name in "${pkgname[@]}" ; do
		echo "
package_${_pkg_name}() {
	echo '======= Fake package() ======='
	echo 'pikaur_fake_makepkg_package'
}
	" >> ./PKGBUILD
	done
fi

fi
# shellcheck disable=SC2068
/usr/bin/makepkg "${new_args[@]}"
